@startuml

!define Table(name,desc) entity name as "desc"
!define primary_key(x) <b>x</b>
!define foreign_key(x) <i>x</i>
!define unique(x) <u>x</u>

' Core Entities

entity USERS {
  * id : UUID <<PK>>
  --
  username : string <<UNIQUE>>
  email : string <<UNIQUE>>
  password_hash : string
  avatar_url : string
  skills : json
  social_links : json
  bio : text
  updated_at : datetime
  --
  register()
  login()
  uploadProfile()
  followUser()
  unfollowUser()
}

entity POSTS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  title : string
  content : text
  cover_image : string
  reading_time : int
  views : int
  answer_id : UUID <<FK>>
  is_comment_id : UUID <<FK>>
  updated_at : datetime
  created_at : datetime
  --
  update()
  delete()
  publishing()
}

entity COMMENTS {
  * id : UUID <<PK>>
  --
  * post_id : UUID <<FK>>
  * question_id : UUID <<FK>>
  * user_id : UUID <<FK>>
  parent_comment_id : UUID <<FK>>
  content : text
  created_at : datetime
  updated_at : datetime
  --
  reply()
  edit()
  delete()
}

entity REACTIONS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * post_id : UUID <<FK>>
  answer_id : UUID <<FK>>
  is_comment_id : UUID <<FK>>
  created_at : datetime
  --
  react()
  unreact()
}

entity CATEGORIES {
  * id : UUID <<PK>>
  --
  * parent_id : UUID <<FK>>
  name : string
  slug : string
  created_at : datetime
  --
  addChild()
  rename()
}

entity TAGS {
  * id : UUID <<PK>>
  --
  name : string <<UNIQUE>>
  slug : string <<UNIQUE>>
  description : text
  created_at : datetime
  --
  rename()
}

entity POST_TAGS {
  * id : UUID <<PK>>
  --
  * post_id : UUID <<FK>>
  * tag_id : UUID <<FK>>
  created_at : datetime
  --
  attach()
  detach()
}

entity POST_CATEGORIES {
  * id : UUID <<PK>>
  --
  * post_id : UUID <<FK>>
  * category_id : UUID <<FK>>
  created_at : datetime
  --
  assign()
  remove()
}

entity BOOKMARKS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * post_id : UUID <<FK>>
  created_at : datetime
  --
  add()
  remove()
}

entity FOLLOWERS {
  * id : UUID <<PK>>
  --
  * follower_id : UUID <<FK>>
  * followed_id : UUID <<FK>>
  created_at : datetime
  --
  follow()
  unfollow()
}

entity NOTIFICATIONS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  type : string
  reference_entity_id : string
  reference_id : UUID
  is_read : boolean
  created_at : datetime
  --
  markRead()
  markAllRead()
}

entity MESSAGES {
  * id : UUID <<PK>>
  --
  * sender_id : UUID <<FK>>
  * receiver_id : UUID <<FK>>
  content : text
  created_at : datetime
  updated_at : datetime
  --
  send()
  markRead()
}

entity QUESTIONS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  title : string
  body : text
  created_at : datetime
  updated_at : datetime
  --
  ask()
  edit()
  close()
}

entity QUESTION_TAGS {
  * id : UUID <<PK>>
  --
  * question_id : UUID <<FK>>
  * tag_id : UUID <<FK>>
  created_at : datetime
  --
  attach()
  detach()
}

entity ANSWERS {
  * id : UUID <<PK>>
  --
  * question_id : UUID <<FK>>
  * user_id : UUID <<FK>>
  body : text
  is_accepted : boolean
  created_at : datetime
  updated_at : datetime
  --
  edit()
  markAsAccepted()
}

' AI & Code Related Entities

entity AI_MODELS {
  * id : UUID <<PK>>
  --
  provider : string
  model_name : string
  api_key : string
  created_at : datetime
  --
  register()
}

entity AI_REQUESTS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * model_id : UUID <<FK>>
  prompt : text
  response : text
  params : json
  created_at : datetime
  completed_at : datetime
  --
  complete()
}

entity AI_RESPONSES {
  * id : UUID <<PK>>
  --
  * ai_request_id : UUID <<FK>>
  response_text : text
  artifacts : json
  created_at : datetime
  --
  store()
}

entity AI_MPC_SESSIONS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  session_name : string
  created_at : datetime
  completed_at : datetime
  --
  start()
  finish()
}

entity AI_MPC_MESSAGES {
  * id : UUID <<PK>>
  --
  * session_id : UUID <<FK>>
  * user_id : UUID <<FK>>
  role : string
  content : text
  created_at : datetime
  --
  send()
}

entity CODE_SNIPPETS {
  * id : UUID <<PK>>
  --
  * post_id : UUID <<FK>>
  language : string
  code : text
  description : text
  updated_at : datetime
  --
  create()
  update()
  execute()
}

entity CODE_EXECUTION_LOGS {
  * id : UUID <<PK>>
  --
  * snippet_id : UUID <<FK>>
  stdout : text
  stderr : text
  exit_code : int
  run_params : json
  created_at : datetime
  --
  record()
}

entity STT_TRANSCRIPTS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  text : text
  language : string
  audio_url : string
  created_at : datetime
  --
  store()
}

entity STT_JOBS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  status : string
  audio_url : string
  status : string
  error : text
  completed_at : datetime
  --
  start()
  complete()
}

entity EMBEDDINGS {
  * id : UUID <<PK>>
  --
  owner_type : string
  owner_id : UUID
  vector_ref : string
  created_at : datetime
  --
  index()
}

entity POST_AI_ARTIFACTS {
  * id : UUID <<PK>>
  --
  * post_id : UUID <<FK>>
  * user_id : UUID <<FK>>
  artifact_type : string
  storage_url : string
  metadata : json
  created_at : datetime
  --
  attach()
}

entity RECOMMENDATION_ITEMS {
  * id : UUID <<PK>>
  --
  * user_id : UUID <<FK>>
  * item_id : UUID
  item_type : string
  score : float
  reason : string
  created_at : datetime
  --
  generate()
}

' Relationships

USERS ||--o{ POSTS : "creates"
USERS ||--o{ COMMENTS : "writes"
USERS ||--o{ REACTIONS : "reacts"
USERS ||--o{ BOOKMARKS : "bookmarks"
USERS ||--o{ FOLLOWERS : "follows (follower)"
USERS ||--o{ FOLLOWERS : "followed by (followed)"
USERS ||--o{ NOTIFICATIONS : "receives"
USERS ||--o{ MESSAGES : "sends"
USERS ||--o{ MESSAGES : "receives"
USERS ||--o{ QUESTIONS : "asks"
USERS ||--o{ ANSWERS : "answers"
USERS ||--o{ AI_REQUESTS : "requests"
USERS ||--o{ AI_MPC_SESSIONS : "creates"
USERS ||--o{ AI_MPC_MESSAGES : "sends"
USERS ||--o{ STT_TRANSCRIPTS : "creates"
USERS ||--o{ STT_JOBS : "creates"
USERS ||--o{ POST_AI_ARTIFACTS : "creates"
USERS ||--o{ RECOMMENDATION_ITEMS : "gets"

POSTS ||--o{ COMMENTS : "has"
POSTS ||--o{ REACTIONS : "receives"
POSTS ||--o{ BOOKMARKS : "bookmarked"
POSTS ||--o{ POST_TAGS : "tagged"
POSTS ||--o{ POST_CATEGORIES : "categorized"
POSTS ||--o{ CODE_SNIPPETS : "contains"
POSTS ||--o{ POST_AI_ARTIFACTS : "has"
POSTS ||--o| ANSWERS : "is answer"

TAGS ||--o{ POST_TAGS : "tagged in"
TAGS ||--o{ QUESTION_TAGS : "tagged in"

CATEGORIES ||--o{ POST_CATEGORIES : "categorizes"
CATEGORIES ||--o| CATEGORIES : "parent/child"

COMMENTS ||--o| COMMENTS : "parent/reply"
COMMENTS ||--o{ REACTIONS : "receives"

QUESTIONS ||--o{ COMMENTS : "has"
QUESTIONS ||--o{ ANSWERS : "has"
QUESTIONS ||--o{ QUESTION_TAGS : "tagged"

ANSWERS ||--o{ REACTIONS : "receives"

AI_MODELS ||--o{ AI_REQUESTS : "processes"

AI_REQUESTS ||--o{ AI_RESPONSES : "generates"

AI_MPC_SESSIONS ||--o{ AI_MPC_MESSAGES : "contains"

CODE_SNIPPETS ||--o{ CODE_EXECUTION_LOGS : "executed"

@enduml
